(-0.000153 * age * MeanSys) +
(0.115232 * Race * diabetes_FBS) +
(-0.092231 * Race * s1b)+
(0.070498 * Race * (CH02l / HDLC3))+
(-0.000173 * Race * MeanSys * h3c) +
(-0.000094 * age * MeanSys * Race),
-11.679980 + (0.064200 * age) +
(0.482835 * Race) +
(-0.000061 * MeanSys^2) +
(0.038950 *MeanSys) +
(2.055533 * h3c) +
(0.842209 * diabetes_FBS) +
(0.895589 * s1b) +
(0.193307 * CH02l / HDLC3) +
(-0.014207 * MeanSys * h3c) +
(0.011609 * MeanSys *Race) +
(-0.119460 * h3c * Race) +
(0.000025 * age * MeanSys) +
(-0.077214 * Race * diabetes_FBS) +
(-0.226771 * Race * s1b) +
(-0.117749 * Race * CH02l / HDLC3) +
(0.004190 * Race * h3c * MeanSys) +
(-0.000199 * Race * age * MeanSys)),
ASCVD=100 / (1 + exp(-Term)),
ASCVD_cat=cut(ASCVD,c(0,5,7.5,20,100)),
ASCVD_cat1=cut(ASCVD,c(0,7.5,100)),
ASCVD_cat=factor(ASCVD_cat,levels=c("(0,5]" , "(5,7.5]", "(7.5,20]", "(20,100]")))
# ff=data.f %>% select(c1,h3c,age,CH02l,HDLC3,MeanSys,s1b,diabetes_FBS,Term,ASCVD,ASCVD_cat)%>% filter(!is.na(ASCVD))
data.f= data.f %>% mutate(age_group=cut(age,c(17,39,75,100)))
#######________________________
pop=read_dta("E:/project/STEPS 2021/pop_province_80-92_single_age.dta")
pop$age=as.numeric(pop$age)
pop=pop %>% filter(Province!=25)
pop=pop[pop$year==1395 & pop$age>=18 ,]
pop$age_cat=NA
pop$age_cat[pop$age<25]=18
pop$age_cat[pop$age>=25 & pop$age<35]=25
pop$age_cat[pop$age>=35 & pop$age<45]=35
pop$age_cat[pop$age>=45 & pop$age<55]=45
pop$age_cat[pop$age>=55 & pop$age<65]=55
pop$age_cat[pop$age>=65 & pop$age<70]=65
pop$age_cat[pop$age>=70 ]=70
pop=aggregate(pop$pred2pop~pop$sex_name+pop$area_name+pop$age_cat,FUN = sum)
colnames(pop)=c("c1","area","age_cat","pop")
pop= pop %>% rename(pop18=pop) %>%  mutate(pop25=if_else(age_cat>=25,pop18,0))
p25=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p18=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18))
p18_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18))
p18_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18))
p18_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18))
data.f.q <- data.f  %>%
as_survey_design(strata= i07, weights =W_Questionnaire )
data.f.a <- data.f  %>%
as_survey_design(strata= i07, weights =W_Anthropometry )
data.f.L <- data.f  %>%
as_survey_design(strata= i07, weights =W_Laboratory )
Var_1=c("age_cat","c1","marriagestatus","i20","i21","Redmeat","Saltconsumption","Fishconsumption","Sweetenedbeverages","Nutsorseedsconsumption","al1","al8n","s1b","low_activity","h3c","h88ma","h18n","h20a","h20b","h20e","h20f","odc_1","h18","h19")
i=Var_1[1]
Var_2=c("bmi_cat","htn_ecare14090","HTN")
Var_3=c("diabetes_FBS","diabetes_ecare_GLUC","Dyslipidemia","LDL")
Var_4=c("Total","h17ae","h17be")
j=Var_4[1]
a=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j)) & !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
for (i in Var_1[-1]) {
a1=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
for (i in Var_2) {
a1= data.f.a%>% mutate(!!sym(i):=to_factor(data.f.a[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
for (i in Var_3) {
a1=data.f.L%>% mutate(!!sym(i):=to_factor(data.f.L[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
a1=data.f.q%>%filter(!is.na(!!!sym(j))) %>% group_by(!!!sym(j)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable="TOtal",Category="Total")  %>% relocate(Variable,Category)
a=a %>% bind_rows(a1)
for (j in Var_4[-1]) {
i=Var_1[1]
b=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j)) & !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
for (i in Var_1[-1]) {
b1=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
for (i in Var_2) {
b1= data.f.a%>% mutate(!!sym(i):=to_factor(data.f.a[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
for (i in Var_3) {
b1=data.f.L%>% mutate(!!sym(i):=to_factor(data.f.L[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
b1=data.f.q%>%filter(!is.na(!!!sym(j))) %>% group_by(!!!sym(j)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable="TOtal",Category="Total")  %>% relocate(Variable,Category)
b=b %>% bind_rows(b1)
a=a %>% left_join(b)
}
####_____________ P value
i=Var_1[1]
j="h17ae"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
i=Var_1[1]
j="h17be"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
i=Var_1[1]
j="Total"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
write.xlsx(a,"E:/project/STEPS 2021/CVDsteps/table 1.xlsx")
flextable(a)
var_label(data.f$htn_aware)
var_label(data.f$htn_cover)
var_label(data.f$diabetes_aware)
var_label(data.f$diabetes_cover)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(dplyr)
library(openxlsx)
Sys.setlocale(locale = "persian")
library(srvyr)
library(survey)
library(knitr)
library(flextable)
library(labelled)
library(CVrisk)
library(PooledCohort)
data.f <- read_dta("E:/project/STEPS 2021/steps_2020_7.11.2021_01_p3_final_4.1.2.dta")
data.f = data.f  %>% mutate(Redmeat= if_else(d8m<4,1,2))
data.f = data.f  %>% mutate(Saltconsumption = if_else(d14a<=2,2,1))
data.f = data.f  %>% mutate(Fishconsumption= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(Sweetenedbeverages= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(Nutsorseedsconsumption= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(HTN= if_else(MeanSys>130|MeanDias>80|h3c==1,1,0))
data.f = data.f  %>% mutate(Dyslipidemia=if_else(CH02l>=240|TRIGL>=150|LDL>=140|HDLC3<40,1,0))
data.f=data.f %>% mutate(h17ac=if_else(h17ac==-555,0,as.numeric(h17ac)))
data.f=data.f %>% mutate(h17bc=if_else(h17bc==-555,0,as.numeric(h17bc)))
data.f=data.f %>% mutate(h17ae=if_else(h17ae==-555,0,as.numeric(h17ae)))
data.f=data.f %>% mutate(h3c=if_else(h3c==-555,0,as.numeric(h3c)))
data.f=data.f %>% mutate(h88ma=if_else(h88ma==-555,0,as.numeric(h88ma)))
data.f=data.f %>% mutate(al8n=if_else(al8n==-555,0,as.numeric(al8n)))
data.f=data.f %>% mutate(s1b=if_else(s1b==-555,0,as.numeric(s1b)))
data.f = data.f  %>% mutate(ldl=LDL)
data.f = data.f  %>% mutate(LDL=if_else(LDL>=70,1,0))
data.f = data.f  %>% mutate(Total=if_else(h17ae==1|h17be==1,1,0))
data.f = data.f  %>% mutate(h17c=if_else(h17ac==1|h17bc==1,1,0))
data.f = data.f  %>% mutate(htn_aware=if_else(is.na(htn_aware),0,htn_aware))
data.f = data.f  %>% mutate(htn_cover=if_else(is.na(htn_cover),0,htn_cover))
data.f = data.f  %>% mutate(htn_ecare14090=if_else(is.na(htn_ecare14090),0,htn_ecare14090))
data.f = data.f  %>% mutate(diabetes_aware=if_else(is.na(diabetes_aware),0,diabetes_aware))
data.f = data.f  %>% mutate(diabetes_cover=if_else(is.na(diabetes_cover),0,diabetes_cover))
data.f = data.f  %>% mutate(diabetes_ecare_GLUC=if_else(is.na(diabetes_ecare_GLUC),0,diabetes_ecare_GLUC))
data.f = data.f  %>% mutate(age_group=cut(age,c(0,18,40,75,130),include.lowest = T,right = F))
var_label(data.f$Redmeat)="Red meat"
var_label(data.f$Saltconsumption)="Salt consumption"
var_label(data.f$Fishconsumption)="Fish consumption"
var_label(data.f$Sweetenedbeverages)="Sweetened beverages"
var_label(data.f$Nutsorseedsconsumption)="Nutsorseed sconsumption"
var_label(data.f$al8n)="Had at least six or more standard drinks in last month"
var_label(data.f$s1b)="Currently tobacco smoking"
var_label(data.f$h3c)="Currently taking drug to control blood pressure"
var_label(data.f$h88ma)="Currently taking drugs for high blood sugar"
var_label(data.f$HTN)="Hypertension"
var_label(data.f$Dyslipidemia)="Dislipidemia"
var_label(data.f$LDL)="LDL70"
var_label(data.f$htn_aware)=" Hypertenssion coverage"
var_label(data.f$htn_cover)="Htn coverage"
var_label(data.f$htn_ecare14090)="Hypertenssion effective care (sys<140 & dias<90)"
var_label(data.f$diabetes_aware)="Diabetes awareness"
var_label(data.f$diabetes_cover)="Diabetes coverage"
var_label(data.f$diabetes_ecare_GLUC)="Diabetes effective care (FPG<126)"
Race=0
data.f=data.f %>% mutate(Term=if_else(c1==0 , -12.823110 + (0.106501 * age) +
(0.432440 * Race) +
(0.000056 * MeanSys^2) +
(0.017666 * MeanSys) +
(0.731678 * h3c) +
(0.943970 * diabetes_FBS) +
(1.009790 * s1b) +
(0.151318 *(CH02l / HDLC3)) +
(-0.008580 * age * Race) +
(-0.003647 * MeanSys * h3c) +
(0.006208 * MeanSys * Race) +
(0.152968 * Race * h3c) +
(-0.000153 * age * MeanSys) +
(0.115232 * Race * diabetes_FBS) +
(-0.092231 * Race * s1b)+
(0.070498 * Race * (CH02l / HDLC3))+
(-0.000173 * Race * MeanSys * h3c) +
(-0.000094 * age * MeanSys * Race),
-11.679980 + (0.064200 * age) +
(0.482835 * Race) +
(-0.000061 * MeanSys^2) +
(0.038950 *MeanSys) +
(2.055533 * h3c) +
(0.842209 * diabetes_FBS) +
(0.895589 * s1b) +
(0.193307 * CH02l / HDLC3) +
(-0.014207 * MeanSys * h3c) +
(0.011609 * MeanSys *Race) +
(-0.119460 * h3c * Race) +
(0.000025 * age * MeanSys) +
(-0.077214 * Race * diabetes_FBS) +
(-0.226771 * Race * s1b) +
(-0.117749 * Race * CH02l / HDLC3) +
(0.004190 * Race * h3c * MeanSys) +
(-0.000199 * Race * age * MeanSys)),
ASCVD=100 / (1 + exp(-Term)),
ASCVD_cat=cut(ASCVD,c(0,5,7.5,20,100)),
ASCVD_cat1=cut(ASCVD,c(0,7.5,100)),
ASCVD_cat=factor(ASCVD_cat,levels=c("(0,5]" , "(5,7.5]", "(7.5,20]", "(20,100]")))
# ff=data.f %>% select(c1,h3c,age,CH02l,HDLC3,MeanSys,s1b,diabetes_FBS,Term,ASCVD,ASCVD_cat)%>% filter(!is.na(ASCVD))
data.f= data.f %>% mutate(age_group=cut(age,c(17,39,75,100)))
#######________________________
pop=read_dta("E:/project/STEPS 2021/pop_province_80-92_single_age.dta")
pop$age=as.numeric(pop$age)
pop=pop %>% filter(Province!=25)
pop=pop[pop$year==1395 & pop$age>=18 ,]
pop$age_cat=NA
pop$age_cat[pop$age<25]=18
pop$age_cat[pop$age>=25 & pop$age<35]=25
pop$age_cat[pop$age>=35 & pop$age<45]=35
pop$age_cat[pop$age>=45 & pop$age<55]=45
pop$age_cat[pop$age>=55 & pop$age<65]=55
pop$age_cat[pop$age>=65 & pop$age<70]=65
pop$age_cat[pop$age>=70 ]=70
pop=aggregate(pop$pred2pop~pop$sex_name+pop$area_name+pop$age_cat,FUN = sum)
colnames(pop)=c("c1","area","age_cat","pop")
pop= pop %>% rename(pop18=pop) %>%  mutate(pop25=if_else(age_cat>=25,pop18,0))
p25=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p18=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18))
p18_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18))
p18_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18))
p18_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18))
data.f.q <- data.f  %>%
as_survey_design(strata= i07, weights =W_Questionnaire )
data.f.a <- data.f  %>%
as_survey_design(strata= i07, weights =W_Anthropometry )
data.f.L <- data.f  %>%
as_survey_design(strata= i07, weights =W_Laboratory )
Var_1=c("age_cat","c1","marriagestatus","i20","i21","Redmeat","Saltconsumption","Fishconsumption","Sweetenedbeverages","Nutsorseedsconsumption","al1","al8n","s1b","low_activity","h3c","h88ma","h18n","h20a","h20b","h20e","h20f","odc_1","h18","h19")
i=Var_1[1]
Var_2=c("bmi_cat","htn_aware","htn_cover","htn_ecare14090","HTN")
Var_3=c("diabetes_FBS","diabetes_aware","diabetes_cover","diabetes_ecare_GLUC","Dyslipidemia","LDL")
Var_4=c("Total","h17ae","h17be")
j=Var_4[1]
a=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j)) & !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
for (i in Var_1[-1]) {
a1=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
for (i in Var_2) {
a1= data.f.a%>% mutate(!!sym(i):=to_factor(data.f.a[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
for (i in Var_3) {
a1=data.f.L%>% mutate(!!sym(i):=to_factor(data.f.L[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, Total) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
a=a %>% bind_rows(a1)
}
a1=data.f.q%>%filter(!is.na(!!!sym(j))) %>% group_by(!!!sym(j)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable="TOtal",Category="Total")  %>% relocate(Variable,Category)
a=a %>% bind_rows(a1)
for (j in Var_4[-1]) {
i=Var_1[1]
b=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j)) & !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
for (i in Var_1[-1]) {
b1=data.f.q%>% mutate(!!sym(i):=to_factor(data.f.q[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
for (i in Var_2) {
b1= data.f.a%>% mutate(!!sym(i):=to_factor(data.f.a[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
for (i in Var_3) {
b1=data.f.L%>% mutate(!!sym(i):=to_factor(data.f.L[["variables"]][[i]]))%>%filter(!is.na(!!!sym(j))& !is.na(!!!sym(i))) %>% group_by(!!!sym(j),!!!sym(i)) %>%
summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(!!!sym(i),a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% rename("Category"=i) %>% relocate(Variable)
b=b %>% bind_rows(b1)
}
b1=data.f.q%>%filter(!is.na(!!!sym(j))) %>% group_by(!!!sym(j)) %>% summarise( percent=round(survey_prop(vartype = "ci")*100,2),n=n()) %>% rename("a"=j) %>% mutate(!!sym(j):=paste0(n," (",percent,") "," (",percent_low,",",percent_upp,")"))%>% select(a,!!!sym(j)) %>% spread(a, !!sym(j)) %>% rename(!!paste0("No_",j):="0",!!paste0("Yes_",j):="1")%>% mutate(Variable="TOtal",Category="Total")  %>% relocate(Variable,Category)
b=b %>% bind_rows(b1)
a=a %>% left_join(b)
}
####_____________ P value
i=Var_1[1]
j="h17ae"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
i=Var_1[1]
j="h17be"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
i=Var_1[1]
j="Total"
c=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
for (i in Var_1[-1]) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.q[["variables"]][[i]])),i,var_label(data.f.q[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.q, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_2) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.a[["variables"]][[i]])),i,var_label(data.f.a[["variables"]][[i]])))%>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.a, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
for (i in Var_3) {
c1=data.frame(Variable=if_else(is.null(var_label(data.f.L[["variables"]][[i]])),i,var_label(data.f.L[["variables"]][[i]]))) %>% relocate(Variable)%>%mutate(!!paste0("P_value_",j):=round(svychisq(as.formula(paste0("~",j,"+",i)),design = data.f.L, statistic="adjWald",na.rm=TRUE)$p.value[1,1],3))
c=c %>% bind_rows(c1)
}
a=a %>% left_join(c)
write.xlsx(a,"E:/project/STEPS 2021/CVDsteps/table 1.xlsx")
flextable(a)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(haven)
library(dplyr)
library(openxlsx)
Sys.setlocale(locale = "persian")
library(srvyr)
library(survey)
library(knitr)
library(flextable)
library(labelled)
library(CVrisk)
library(PooledCohort)
data.f <- read_dta("E:/project/STEPS 2021/steps_2020_7.11.2021_01_p3_final_4.1.2.dta")
data.f = data.f  %>% mutate(Redmeat= if_else(d8m<4,1,2))
data.f = data.f  %>% mutate(Saltconsumption = if_else(d14a<=2,2,1))
data.f = data.f  %>% mutate(Fishconsumption= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(Sweetenedbeverages= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(Nutsorseedsconsumption= if_else(d14a<=3,1,2))
data.f = data.f  %>% mutate(HTN= if_else(MeanSys>130|MeanDias>80|h3c==1,1,0))
data.f = data.f  %>% mutate(Dyslipidemia=if_else(CH02l>=240|TRIGL>=150|LDL>=140|HDLC3<40,1,0))
data.f=data.f %>% mutate(h17ac=if_else(h17ac==-555,0,as.numeric(h17ac)))
data.f=data.f %>% mutate(h17bc=if_else(h17bc==-555,0,as.numeric(h17bc)))
data.f=data.f %>% mutate(h17ae=if_else(h17ae==-555,0,as.numeric(h17ae)))
data.f=data.f %>% mutate(h3c=if_else(h3c==-555,0,as.numeric(h3c)))
data.f=data.f %>% mutate(h88ma=if_else(h88ma==-555,0,as.numeric(h88ma)))
data.f=data.f %>% mutate(al8n=if_else(al8n==-555,0,as.numeric(al8n)))
data.f=data.f %>% mutate(s1b=if_else(s1b==-555,0,as.numeric(s1b)))
data.f = data.f  %>% mutate(ldl=LDL)
data.f = data.f  %>% mutate(LDL=if_else(LDL>=70,1,0))
data.f = data.f  %>% mutate(Total=if_else(h17ae==1|h17be==1,1,0))
data.f = data.f  %>% mutate(h17c=if_else(h17ac==1|h17bc==1,1,0))
data.f = data.f  %>% mutate(htn_aware=if_else(is.na(htn_aware),0,htn_aware))
data.f = data.f  %>% mutate(htn_cover=if_else(is.na(htn_cover),0,htn_cover))
data.f = data.f  %>% mutate(htn_ecare14090=if_else(is.na(htn_ecare14090),0,htn_ecare14090))
data.f = data.f  %>% mutate(diabetes_aware=if_else(is.na(diabetes_aware),0,diabetes_aware))
data.f = data.f  %>% mutate(diabetes_cover=if_else(is.na(diabetes_cover),0,diabetes_cover))
data.f = data.f  %>% mutate(diabetes_ecare_GLUC=if_else(is.na(diabetes_ecare_GLUC),0,diabetes_ecare_GLUC))
data.f = data.f  %>% mutate(age_group=cut(age,c(0,18,40,75,130),include.lowest = T,right = F))
var_label(data.f$Redmeat)="Red meat"
var_label(data.f$Saltconsumption)="Salt consumption"
var_label(data.f$Fishconsumption)="Fish consumption"
var_label(data.f$Sweetenedbeverages)="Sweetened beverages"
var_label(data.f$Nutsorseedsconsumption)="Nutsorseed sconsumption"
var_label(data.f$al8n)="Had at least six or more standard drinks in last month"
var_label(data.f$s1b)="Currently tobacco smoking"
var_label(data.f$h3c)="Currently taking drug to control blood pressure"
var_label(data.f$h88ma)="Currently taking drugs for high blood sugar"
var_label(data.f$HTN)="Hypertension"
var_label(data.f$Dyslipidemia)="Dislipidemia"
var_label(data.f$LDL)="LDL70"
var_label(data.f$htn_aware)=" Hypertenssion awareness"
var_label(data.f$htn_cover)="Htn coverage"
var_label(data.f$htn_ecare14090)="Hypertenssion effective care (sys<140 & dias<90)"
var_label(data.f$diabetes_aware)="Diabetes awareness"
var_label(data.f$diabetes_cover)="Diabetes coverage"
var_label(data.f$diabetes_ecare_GLUC)="Diabetes effective care (FPG<126)"
Race=0
data.f=data.f %>% mutate(Term=if_else(c1==0 , -12.823110 + (0.106501 * age) +
(0.432440 * Race) +
(0.000056 * MeanSys^2) +
(0.017666 * MeanSys) +
(0.731678 * h3c) +
(0.943970 * diabetes_FBS) +
(1.009790 * s1b) +
(0.151318 *(CH02l / HDLC3)) +
(-0.008580 * age * Race) +
(-0.003647 * MeanSys * h3c) +
(0.006208 * MeanSys * Race) +
(0.152968 * Race * h3c) +
(-0.000153 * age * MeanSys) +
(0.115232 * Race * diabetes_FBS) +
(-0.092231 * Race * s1b)+
(0.070498 * Race * (CH02l / HDLC3))+
(-0.000173 * Race * MeanSys * h3c) +
(-0.000094 * age * MeanSys * Race),
-11.679980 + (0.064200 * age) +
(0.482835 * Race) +
(-0.000061 * MeanSys^2) +
(0.038950 *MeanSys) +
(2.055533 * h3c) +
(0.842209 * diabetes_FBS) +
(0.895589 * s1b) +
(0.193307 * CH02l / HDLC3) +
(-0.014207 * MeanSys * h3c) +
(0.011609 * MeanSys *Race) +
(-0.119460 * h3c * Race) +
(0.000025 * age * MeanSys) +
(-0.077214 * Race * diabetes_FBS) +
(-0.226771 * Race * s1b) +
(-0.117749 * Race * CH02l / HDLC3) +
(0.004190 * Race * h3c * MeanSys) +
(-0.000199 * Race * age * MeanSys)),
ASCVD=100 / (1 + exp(-Term)),
ASCVD_cat=cut(ASCVD,c(0,5,7.5,20,100)),
ASCVD_cat1=cut(ASCVD,c(0,7.5,100)),
ASCVD_cat=factor(ASCVD_cat,levels=c("(0,5]" , "(5,7.5]", "(7.5,20]", "(20,100]")))
# ff=data.f %>% select(c1,h3c,age,CH02l,HDLC3,MeanSys,s1b,diabetes_FBS,Term,ASCVD,ASCVD_cat)%>% filter(!is.na(ASCVD))
data.f= data.f %>% mutate(age_group=cut(age,c(17,39,75,100)))
#######________________________
pop=read_dta("E:/project/STEPS 2021/pop_province_80-92_single_age.dta")
pop$age=as.numeric(pop$age)
pop=pop %>% filter(Province!=25)
pop=pop[pop$year==1395 & pop$age>=18 ,]
pop$age_cat=NA
pop$age_cat[pop$age<25]=18
pop$age_cat[pop$age>=25 & pop$age<35]=25
pop$age_cat[pop$age>=35 & pop$age<45]=35
pop$age_cat[pop$age>=45 & pop$age<55]=45
pop$age_cat[pop$age>=55 & pop$age<65]=55
pop$age_cat[pop$age>=65 & pop$age<70]=65
pop$age_cat[pop$age>=70 ]=70
pop=aggregate(pop$pred2pop~pop$sex_name+pop$area_name+pop$age_cat,FUN = sum)
colnames(pop)=c("c1","area","age_cat","pop")
pop= pop %>% rename(pop18=pop) %>%  mutate(pop25=if_else(age_cat>=25,pop18,0))
p25=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p25_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18)) %>% filter(age_cat>=25)
p18=pop %>%group_by(age_cat) %>% summarise(p=sum(pop18))
p18_s=pop %>%group_by(age_cat,c1) %>% summarise(p=sum(pop18))
p18_a=pop %>%group_by(age_cat,area) %>% summarise(p=sum(pop18))
p18_sa=pop %>%group_by(age_cat,c1,area) %>% summarise(p=sum(pop18))
shiny::runApp()
shiny::runApp()
shiny::runApp()
